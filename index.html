<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="manifest" href="manifest.json" />
<title>‚ö°App Demonstra√ß√£o</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Tela de abertura */
#splash {
  position: fixed;
  inset: 0;
  background: #111827; /* fundo escuro */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Logo */
#splash img {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 4px solid #FFD700;
  margin-bottom: 20px;
}

/* Barra de carregamento */
.loader-bar {
  width: 200px;
  height: 8px;
  background: #333;
  border-radius: 999px;
  overflow: hidden;
}
.loader-fill {
  height: 100%;
  width: 0%;
  background: #FFD700;
  border-radius: 999px;
  animation: loadFill 3s linear forwards;
}
@keyframes loadFill {
  from { width: 0%; }
  to { width: 100%; }
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 3px; }
::-webkit-scrollbar-track { background: #1F2937; }
.product-card { background: #1F2937; border-radius: 1rem; padding: 1rem; text-align: center; transition: transform 0.2s; display:flex; flex-direction:column; justify-content:start; }
.product-card img { width:100%; height:200px; object-fit:cover; border-radius:0.75rem; margin-bottom:0.5rem; }
.product-card:hover { transform: scale(1.03); }
.cart-panel { position: fixed; top: 0; right: 0; height: 100%; width: 90%; max-width: 400px; background: #111827; z-index: 50; padding: 1rem; transform: translateX(100%); transition: transform 0.3s; overflow-y: auto; }
.cart-panel.show { transform: translateX(0); }
.btn { cursor: pointer; transition: transform 0.2s; }
.btn:hover { transform: scale(1.05); }
.category-filter { display:flex; gap:0.5rem; overflow-x:auto; padding-bottom:0.5rem; }
.category-filter button { flex-shrink:0; white-space:nowrap; background:#FFD700; color:black; px-3 py-1 rounded font-semibold; cursor:pointer; transition:0.2s; border-radius: 5px; width: 150px; }
.category-filter button.active { background:#FACC15; }
.toast { position: fixed; top: 1rem; right: 1rem; background: #FFD700; color: black; padding: 0.5rem 1rem; border-radius: 0.5rem; z-index: 100; opacity:0; transition: opacity 0.3s; }
.toast.show { opacity:1; }
</style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
<!-- HEADER COM FUNDO E LOGO -->
  <!-- Logo redonda -->
  <div class="absolute top-4 flex justify-center w-full">
    <img src="logo.png" alt="Logo" class="w-20 h-20 rounded-full border-4 border-yellow-400 shadow-lg">
  </div>
  <!-- Tela de abertura -->
<div id="splash">
  <img class="logo" src="logo.png" alt="Logo">
  <h1>
  	Aplicativo Demonstra√ß√£o 
  </h1>
 <br>
  <div class="loader-bar">
    <div class="loader-fill"></div>
  </div>
  <h3>
  	www.atecseven.com.br
  </h3>
</div>

  <!-- T√≠tulo -->
  <h1 class="text-yellow-400 text-3xl font-bold mt-28 text-center">üçîApp Demonstra√ß√£o‚ö°</h1>
</header>
<div id="installPrompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
background: #FFD700; color: #121212; padding: 12px 20px; border-radius: 30px;
font-weight: bold; box-shadow: 0 0 10px #FFD700aa; z-index: 9999; cursor: pointer;">
  Instalar Aplicativoüì≤
</div>
<div class="max-w-5xl mx-auto p-4">

  <!-- BUSCA -->
  <input id="searchInput" placeholder="Buscar produtos..." class="w-full p-3 mb-2 rounded bg-gray-700 border border-gray-600"/>

  <!-- FILTRO DE CATEGORIAS -->
  <div id="categoryFilter" class="category-filter mb-4"></div>

  <!-- PRODUTOS -->
  <div id="productList" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6"></div>

  <!-- BOT√ÉO ABRIR CARRINHO COM TOTAL DE ITENS -->
  <button id="btnToggleCart" class="fixed bottom-4 right-4 bg-yellow-400 text-black px-4 py-3 rounded-full font-bold shadow-lg btn z-50">
    üõí Carrinho <span id="cartCount" class="bg-red-600 text-white px-2 py-0.5 rounded-full ml-1 text-sm">0</span>
  </button>

  <!-- PAINEL DO CARRINHO -->
  <div id="cartPanel" class="cart-panel">
    <h2 class="text-xl font-bold mb-2">üõí Carrinho</h2>
    <div id="cartList" class="mb-4"></div>
    <div class="mb-4">
  <label class="inline-flex items-center gap-2">
    <input type="checkbox" id="saveCustomerData" class="rounded bg-gray-700 border-gray-600"/>
    <span>Salvar meus dados para pr√≥ximos pedidos</span>
  </label>
</div>

    <div class="mb-4">
      <label class="block mb-1">Nome</label>
      <input id="customerName" class="w-full p-2 rounded bg-gray-700 border border-gray-600"/>
      <label class="block mt-2 mb-1">WhatsApp</label>
      <input id="customerWhats" class="w-full p-2 rounded bg-gray-700 border border-gray-600"/>
    </div>
    <div class="mb-4">
      <label class="block mb-1">Entrega ou Retirada?</label>
      <select id="deliveryType" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        <option value="entrega">Entrega (+R$10)</option>
        <option value="retirada">Retirada</option>
      </select>
    </div>
    <div id="addressDiv" class="mb-4">
      <label class="block mb-1">Endere√ßo</label>
      <input id="address" class="w-full p-2 rounded bg-gray-700 border border-gray-600"/>
    </div>

    <div class="mb-4">
  <label class="block mb-1">Observa√ß√£o do Cliente</label>
  <textarea id="customerObs" rows="2" class="w-full p-2 rounded bg-gray-700 border border-gray-600"></textarea>
</div>
    <div class="mb-4">
      <label class="block mb-1">Forma de pagamento</label>
      <select id="paymentMethod" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        <option value="pix">Pix</option>
        <option value="dinheiro">Dinheiro</option>
        <option value="credito">Cart√£o de Cr√©dito (sujeito a taxa)</option>
        <option value="debito">Cart√£o de D√©bito (sujeito a taxa)</option>
      </select>
    </div>
    <div class="flex justify-between items-center mb-4">
      <div class="text-yellow-400 font-bold text-xl">Total: <span id="totalPrice">R$0,00</span></div>
      <button id="btnPlaceOrder" class="bg-yellow-400 text-black px-4 py-2 rounded font-semibold btn">‚úÖ Finalizar</button>
    </div>
    <div id="pixMessage" class="hidden mb-4 p-3 rounded bg-green-700 text-black">
      Ap√≥s confirmar o pedido, envie o comprovante via WhatsApp clicando no bot√£o abaixo.
      <a id="pixWhatsBtn" href="#" target="_blank" class="block mt-2 bg-yellow-400 text-black px-4 py-2 rounded text-center btn">Enviar Comprovante</a>
    </div>
    <button id="btnCloseCart" class="w-full bg-gray-700 text-white py-2 rounded btn">Fechar</button>
  </div>

  <!-- √öLTIMOS PEDIDOS -->
  <h2 class="text-xl font-bold mt-6 mb-2">üì¶ √öltimos Pedidos</h2>
  <div id="lastOrders"></div>
</div>

<!-- MENSAGEM P√ìS-PEDIDO -->
<div id="orderComplete" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex flex-col justify-center items-center text-center p-4 hidden z-50 text-gray-100">
  <h2 class="text-3xl font-bold mb-4">üòâObrigado Pela Prefer√™ncia!</h2>
  <p class="mb-4">Seu pedido est√° sendo preparado com carinhoüíõ. Assim que estiver a caminho ou pronto para retirada, voc√™ receber√° uma mensagem no WhatsApp informado ‚Äî ou, se preferir, acompanhe tudo em tempo real aqui pelo aplicativo.</p>
  <button id="contactStore" class="bg-yellow-400 text-black px-4 py-2 rounded font-semibold btn mb-4">Entrar em contato com a loja</button>
  <div id="orderTimer" class="bg-gray-800 p-3 rounded">Tempo desde o pedido: <span id="timer">00:00:00</span></div>
  <!-- TIMELINE DO PEDIDO (COLE AQUI DENTRO DO orderComplete) -->
<div id="orderTimeline" class="w-full max-w-md my-4 mx-auto hidden">
  <div class="flex justify-between items-center text-sm font-semibold text-gray-300">
    <div id="stepPreparando">Preparando</div>
    <div id="stepEntregaRetirada">...</div>
    <div id="stepFinalizado">Finalizado</div>
  </div>
  <div class="relative h-2 bg-gray-600 rounded mt-1">
    <div id="progressBar" class="absolute h-2 bg-yellow-400 rounded w-0" style="transition: width 500ms ease;"></div>
  </div>
</div>

  <button id="btnReceived" class="mt-4 bg-green-600 text-white px-4 py-2 rounded btn"><b>Recebi meu pedido</b></button>
</div>

<div id="toastContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import { getDatabase, ref, onValue, push, update, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

// --- Configura√ß√£o Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyBzK6HfalJpnGaGFZptwJUfIkpugvevHNs",
  authDomain: "delivery-demo-54f9c.firebaseapp.com",
  databaseURL: "https://delivery-demo-54f9c-default-rtdb.firebaseio.com",
  projectId: "delivery-demo-54f9c",
  storageBucket: "delivery-demo-54f9c.firebasestorage.app",
  messagingSenderId: "77029251394",
  appId: "1:77029251394:web:5a4eca50ff529b96f710db"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Utils ---
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const brl = v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

// --- √Åudios ---
const audioEntrega = new Audio('https://dl.dropbox.com/scl/fi/8ht99jq95fvg8meyvf6ud/SAIU-PARA-ENTREGA-FOOD.mp3?dl=1');
const audioRetirada = new Audio('https://dl.dropbox.com/scl/fi/0v5wnfiymzspq495dzwzh/SEU-PEDIDO-ESTA-PRONTO.mp3?dl=1');
audioEntrega.preload = 'auto';
audioRetirada.preload = 'auto';

// desbloquear autoplay
document.addEventListener('click', function unlockAudioOnce() {
  audioEntrega.play().then(()=>audioEntrega.pause()).catch(()=>{});
  audioRetirada.play().then(()=>audioRetirada.pause()).catch(()=>{});
  document.removeEventListener('click', unlockAudioOnce);
});

// --- Estado ---
let PRODUCTS = [];
let CART = JSON.parse(localStorage.getItem('cart')) || [];
let LAST_ORDERS = JSON.parse(localStorage.getItem('lastOrders')) || [];
let ORDER_COMPLETE = JSON.parse(localStorage.getItem('orderComplete')) || null;
let ORDER_START_TIME = localStorage.getItem('orderStartTime') || null;

// --- DOM refs ---
const productListEl = $('#productList');
const cartListEl = $('#cartList');
const totalPriceEl = $('#totalPrice');
const searchInput = $('#searchInput');
const deliveryTypeSelect = $('#deliveryType');
const addressDiv = $('#addressDiv');
const addressInput = $('#address');
const customerName = $('#customerName');
const customerWhats = $('#customerWhats');
const paymentMethod = $('#paymentMethod');
const btnPlaceOrder = $('#btnPlaceOrder');
const lastOrdersEl = $('#lastOrders');
const cartPanel = $('#cartPanel');
const btnToggleCart = $('#btnToggleCart');
const btnCloseCart = $('#btnCloseCart');
const pixMessage = $('#pixMessage');
const pixWhatsBtn = $('#pixWhatsBtn');
const categoryFilterEl = $('#categoryFilter');
const toastContainer = $('#toastContainer');
const cartCountEl = $('#cartCount');
const orderCompleteEl = $('#orderComplete');
const contactStoreBtn = $('#contactStore');
const orderTimerEl = $('#timer');
const btnReceived = $('#btnReceived');
const saveDataCheckbox = $('#saveCustomerData');

// timeline elements seguros
function $safe(id){ return document.getElementById(id); }

// --- Dados do cliente ---
function loadCustomerData() {
  const saved = JSON.parse(localStorage.getItem('customerData')) || {};
  if(saved.name) customerName.value = saved.name;
  if(saved.whats) customerWhats.value = saved.whats;
  if(saved.address) addressInput.value = saved.address;
  saveDataCheckbox.checked = !!saved.name || !!saved.whats || !!saved.address;
}

function saveCustomerData() {
  if(saveDataCheckbox.checked){
    localStorage.setItem('customerData', JSON.stringify({
      name: customerName.value,
      whats: customerWhats.value,
      address: addressInput.value
    }));
  } else localStorage.removeItem('customerData');
}

// evento de carregamento e salvamento
btnToggleCart.addEventListener('click', loadCustomerData);
customerName.addEventListener('input', saveCustomerData);
customerWhats.addEventListener('input', saveCustomerData);
addressInput.addEventListener('input', saveCustomerData);
saveDataCheckbox.addEventListener('change', saveCustomerData);

// --- Toast ---
function showToast(msg){
  const div=document.createElement('div');
  div.className='toast show';
  div.textContent=msg;
  toastContainer.appendChild(div);
  setTimeout(()=> div.remove(),2500);
}

function updateCartCount(){
  const totalItems = CART.reduce((sum,c)=>sum+c.qtd,0);
  cartCountEl.textContent = totalItems;
}

/* ----------------- PRODUTOS ----------------- */
onValue(ref(db,'produtos'), snap=>{
  PRODUCTS=[];
  snap.forEach(ch=>{
    const p = ch.val();
    if(!p.inativo) PRODUCTS.push({id: ch.key, ...p});
  });
  renderCategoryFilter();
  renderProductList();
});

let activeCategory='';
function renderCategoryFilter(){
  const categorias = Array.from(new Set(PRODUCTS.map(p=>p.categoria).filter(Boolean))).sort();
  categoryFilterEl.innerHTML='';
  categorias.forEach(cat=>{
    const btn=document.createElement('button');
    btn.textContent=cat;
    btn.onclick=()=>{
      activeCategory=(activeCategory===cat?'':cat);
      $$('.category-filter button').forEach(b=>b.classList.remove('active'));
      if(activeCategory) btn.classList.add('active');
      renderProductList();
    };
    categoryFilterEl.appendChild(btn);
  });
}

function renderProductList(){
  const term = (searchInput.value||'').toLowerCase();
  productListEl.innerHTML='';
  PRODUCTS.filter(p=>{
    const textMatch=`${p.nome} ${p.descricao} ${p.categoria||''}`.toLowerCase().includes(term);
    const catMatch = activeCategory? p.categoria===activeCategory : true;
    return textMatch && catMatch;
  }).forEach(p=>{
    const div=document.createElement('div');
    div.className='product-card relative';
    const promoBadge = p.promocional ? `<div class="absolute top-2 left-2 bg-gradient-to-r from-yellow-400 to-red-500 text-white font-bold text-xs px-2 py-1 rounded shadow-lg">ITEM PROMOCIONALüî•</div>` : '';
    div.innerHTML=`
      ${promoBadge}
      <img src="${p.imagem||''}" alt="${p.nome}"/>
      <div class="font-bold text-lg mb-1">${p.nome}</div>
      <div class="text-xs text-gray-400 mb-1">${p.categoria||''}</div>
      <div class="text-sm text-gray-300 mb-2">${p.descricao||''}</div>
      <div class="text-yellow-400 font-bold mb-2">${brl(p.preco)}</div>
      <div class="flex items-center justify-center gap-2">
        <label>Qtd:</label>
        <input type="number" min="1" value="1" class="w-12 text-black rounded px-1 qtyInput"/>
      </div>
      <button class="bg-yellow-400 text-black px-3 py-1 rounded mt-2 btn addBtn">Adicionar</button>
    `;
    productListEl.appendChild(div);
    const qtyInput = div.querySelector('.qtyInput');
    div.querySelector('.addBtn').onclick=()=>{
      const qty = parseInt(qtyInput.value)||1;
      const idx = CART.findIndex(c=>c.id===p.id);
      if(idx>-1) CART[idx].qtd += qty; else CART.push({id:p.id,nome:p.nome,preco:p.preco,qtd:qty});
      localStorage.setItem('cart',JSON.stringify(CART));
      renderCart();
      showToast(`${p.nome} adicionado ao carrinho!`);
    };
  });
}

/* ----------------- CARRINHO ----------------- */
function renderCart(){
  cartListEl.innerHTML='';
  let total=0;
  CART.forEach((c,i)=>{
    total += c.preco*c.qtd;
    const div=document.createElement('div');
    div.className='bg-gray-800 p-2 rounded mb-2 flex justify-between items-center';
    div.innerHTML=`
      <div>
        <div class="font-bold">${c.nome}</div>
        <div>${brl(c.preco)} x ${c.qtd} = ${brl(c.preco*c.qtd)}</div>
      </div>
      <div class="flex flex-col gap-1">
        <input type="number" min="1" value="${c.qtd}" class="w-16 text-black rounded px-1 qtyCart"/>
        <button class="bg-red-600 text-white px-2 py-1 rounded btn removeBtn">Remover</button>
      </div>
    `;
    cartListEl.appendChild(div);
    const qtyCart = div.querySelector('.qtyCart');
    qtyCart.onchange=()=>{
      CART[i].qtd = parseInt(qtyCart.value)||1;
      localStorage.setItem('cart',JSON.stringify(CART));
      renderCart();
      showToast(`Quantidade de ${c.nome} atualizada!`);
    };
    div.querySelector('.removeBtn').onclick=()=>{
      CART.splice(i,1);
      localStorage.setItem('cart',JSON.stringify(CART));
      renderCart();
      showToast(`${c.nome} removido do carrinho!`);
    };
  });
  if(deliveryTypeSelect.value==='entrega') total+=10;
  totalPriceEl.textContent = brl(total);
  updateCartCount();
}

/* ----------------- UI COMPORTAMENTOS ----------------- */
deliveryTypeSelect.onchange = () => { addressDiv.style.display = deliveryTypeSelect.value==='entrega'?'block':'none'; };
btnToggleCart.onclick = ()=> cartPanel.classList.add('show');
btnCloseCart.onclick = ()=> cartPanel.classList.remove('show');
document.addEventListener('click', e=>{ if(!cartPanel.contains(e.target)&&!btnToggleCart.contains(e.target)) cartPanel.classList.remove('show'); });

/* ----------------- FINALIZAR PEDIDO ----------------- */
btnPlaceOrder.onclick = () => {
  if (CART.length === 0) return showToast('Adicione pelo menos um produto ao carrinho!');
  if (!customerName.value || !customerWhats.value) return showToast('Preencha nome e WhatsApp!');
  if (deliveryTypeSelect.value === 'entrega' && !addressInput.value) return showToast('Informe o endere√ßo!');

  let troco = null;
  if (paymentMethod.value === 'dinheiro') {
    const trocoInput = prompt('Para quanto deseja o troco?');
    if (!trocoInput || isNaN(Number(trocoInput))) return showToast('Informe um valor v√°lido para o troco!');
    troco = `Troco para: ${Number(trocoInput).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}`;
  }

  const total = CART.reduce((sum,c)=>sum+c.preco*c.qtd,0) + (deliveryTypeSelect.value==='entrega'?10:0);
  const numeroPedido = Math.floor(Math.random()*900000000) + 100000000;
  const order = {
    numero: numeroPedido,
    cliente: customerName.value,
    telefone: customerWhats.value,
    delivery: deliveryTypeSelect.value,
    address: addressInput.value,
    observacao: (document.getElementById('customerObs')?.value||""),
    payment: paymentMethod.value,
    troco: troco,
    total,
    itens: CART.map(c=>({...c})),
    status:'Preparando',
    createdAt: new Date().toISOString()
  };

  push(ref(db,'pedidos'),order)
    .then(res=>{
      order.firebaseKey = res.key;
      ORDER_COMPLETE = order;
      ORDER_START_TIME = Date.now();
      localStorage.setItem('orderComplete',JSON.stringify(ORDER_COMPLETE));
      localStorage.setItem('orderStartTime',ORDER_START_TIME);

      showToast('Pedido registrado com sucesso!');

      LAST_ORDERS.unshift(order);
      if(LAST_ORDERS.length>5) LAST_ORDERS.pop();
      localStorage.setItem('lastOrders',JSON.stringify(LAST_ORDERS));

      CART = [];
      localStorage.removeItem('cart');
      renderCart();
      renderLastOrders();
      showOrderComplete();
      monitorStatus(ORDER_COMPLETE);
    })
    .catch(err=>{
      console.error(err);
      showToast('Erro ao registrar pedido!');
    });
};

/* ----------------- √öLTIMOS PEDIDOS ----------------- */
function renderLastOrders(){
  lastOrdersEl.innerHTML='';
  LAST_ORDERS.forEach(o=>{
    const div=document.createElement('div');
    div.className='bg-gray-800 p-2 rounded mb-2';
    div.innerHTML=`
      <div class="flex justify-between">
        <div class="font-bold">${o.cliente}</div>
        <div>${brl(o.total)}</div>
      </div>
      <div class="text-xs text-gray-400">${o.status}</div>
    `;
    lastOrdersEl.appendChild(div);
  });
}

/* ----------------- TELA PEDIDO CONCLU√çDO E TIMER ----------------- */
function showOrderComplete(){
  if(!ORDER_COMPLETE) return;
  orderCompleteEl.classList.remove('hidden');
  updateOrderTimer();
  monitorStatus(ORDER_COMPLETE);
}

function updateOrderTimer(){
  if(!ORDER_START_TIME) return;
  const diff = Date.now() - ORDER_START_TIME;
  const h = String(Math.floor(diff/3600000)).padStart(2,'0');
  const m = String(Math.floor(diff/60000)%60).padStart(2,'0');
  const s = String(Math.floor(diff/1000)%60).padStart(2,'0');
  orderTimerEl.textContent = `${h}:${m}:${s}`;
  setTimeout(updateOrderTimer,1000);
}

/* ----------------- CONTATO E RECEBIMENTO ----------------- */
contactStoreBtn.onclick = ()=>{ if(!ORDER_COMPLETE) return; window.open(`https://wa.me/55${ORDER_COMPLETE.telefone}?text=Ol√°!`, '_blank'); };

btnReceived.onclick = ()=>{
  if(!ORDER_COMPLETE?.firebaseKey) return;
  const pedidoRef = ref(db,'pedidos/'+ORDER_COMPLETE.firebaseKey);
  update(pedidoRef,{status:'Finalizado'})
    .then(()=>{
      ORDER_COMPLETE.status='Finalizado';
      localStorage.setItem('orderComplete',JSON.stringify(ORDER_COMPLETE));
      const idx = LAST_ORDERS.findIndex(o=>o.numero===ORDER_COMPLETE.numero);
      if(idx>-1){ LAST_ORDERS[idx].status='Finalizado'; localStorage.setItem('lastOrders',JSON.stringify(LAST_ORDERS)); renderLastOrders(); }
      ORDER_COMPLETE=null;
      ORDER_START_TIME=null;
      localStorage.removeItem('orderComplete');
      localStorage.removeItem('orderStartTime');
      orderCompleteEl.classList.add('hidden');
      showToast('Pedido finalizado com sucesso!');
    })
    .catch(err=>{ console.error(err); showToast('Obrigado!'); });
};

/* ----------------- MONITORAMENTO EM TEMPO REAL ----------------- */
function normalizeStatus(s){ return s? String(s).trim().toLowerCase() : ''; }

// vari√°vel global para guardar progresso m√°ximo por pedido
const orderMaxProgress = {}; // { orderKey: 0..100 }

function updateTimelineUI(status, deliveryType, firstLoad=false){
  const timelineEl = $safe('orderTimeline');
  const stepPreparando = $safe('stepPreparando');
  const stepEntregaRetirada = $safe('stepEntregaRetirada');
  const stepFinalizado = $safe('stepFinalizado');
  const progressBar = $safe('progressBar');
  if(!timelineEl||!stepPreparando||!stepEntregaRetirada||!stepFinalizado||!progressBar) return;

  const s = normalizeStatus(status);
  const orderKey = currentOrderKey();

  // fun√ß√£o auxiliar para formatar hora
  function formatHoraAgora(){
    const now = new Date();
    return `Hoje √†s ${now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
  }

  // fun√ß√£o auxiliar para mostrar o texto abaixo do passo
  function setStepTime(stepEl){
    if(!stepEl) return;
    let info = stepEl.querySelector('.step-time');
    if(!info){
      info = document.createElement('div');
      info.className = 'step-time';
      info.style.fontSize = '12px';
      info.style.color = '#666';
      stepEl.appendChild(info);
    }
    info.textContent = formatHoraAgora();
  }

  // fun√ß√£o auxiliar para atualizar barra garantindo progresso crescente
  function setProgress(widthPercent){
    const maxSoFar = orderMaxProgress[orderKey] || 0;
    if(widthPercent > maxSoFar){
      progressBar.style.width = widthPercent + '%';
      orderMaxProgress[orderKey] = widthPercent;
    }
  }

  timelineEl.classList.remove('hidden');

  // --- ENTREGA ---
  if(deliveryType==='entrega'){
    stepPreparando.textContent='Preparando';
    stepEntregaRetirada.textContent='Saiu para entrega';
    stepFinalizado.textContent='Conclu√≠do';
    stepFinalizado.classList.remove('hidden');

    if(s==='preparando'){
      setProgress(33);
      setStepTime(stepPreparando);
    } else if(['saiu para entrega','saiu-para-entrega','saiu_para_entrega'].includes(s)){
      setProgress(66);
      if(!firstLoad) playAudioIfNeeded(orderKey,'entrega');
      setStepTime(stepEntregaRetirada);
    } else if(s==='finalizado'){
      setProgress(100);
      setStepTime(stepFinalizado);
      timelineEl.classList.add('hidden'); // fecha tela
    }
  }

  // --- RETIRADA ---
  else if(deliveryType==='retirada'){
    stepPreparando.textContent='Preparando';
    stepEntregaRetirada.textContent='Aguardando Retirada';
    stepFinalizado.classList.add('hidden'); // n√£o mostra "Conclu√≠do"

    if(s==='preparando'){
      setProgress(33);
      setStepTime(stepPreparando);
    } else if(s==='finalizado'){
      setProgress(100);
      if(!firstLoad) playAudioIfNeeded(orderKey,'retirada');
      setStepTime(stepEntregaRetirada);
    } else {
      setProgress(66);
      if(!firstLoad) playAudioIfNeeded(orderKey,'retirada');
      setStepTime(stepEntregaRetirada);
    }
  }
}


function currentOrderKey(){ return ORDER_COMPLETE?.firebaseKey || ORDER_COMPLETE?.key || null; }

function monitorStatus(order){
  if(!order) return;

  if(!order.firebaseKey){
    const pedidosRef = ref(db,'pedidos');
    const q = query(pedidosRef, orderByChild('numero'), equalTo(order.numero));
    get(q).then(snap=>{
      if(snap.exists()){
        snap.forEach(ch=>{ order.firebaseKey=ch.key; ORDER_COMPLETE.firebaseKey=ch.key; localStorage.setItem('orderComplete',JSON.stringify(ORDER_COMPLETE)); });
        monitorStatus(order);
      } else console.warn('N√£o encontrou firebaseKey para pedido local',order.numero);
    }).catch(err=>{ console.error('Erro ao procurar firebaseKey',err); });
    return;
  }

  const orderRef = ref(db,'pedidos/'+order.firebaseKey);
  updateTimelineUI(order.status,order.delivery,true);
  localStorage.setItem('orderStatus_'+order.firebaseKey,normalizeStatus(order.status||''));

  onValue(orderRef, snap=>{
    const data = snap.val();
    if(!data) return;
    const newStatus = normalizeStatus(data.status||'');
    const prevStatus = localStorage.getItem('orderStatus_'+order.firebaseKey)||'';
    updateTimelineUI(data.status,data.delivery,false);

    if(newStatus!==prevStatus){
      if(data.delivery==='entrega' && ['saiu para entrega','saiu-para-entrega','saiu_para_entrega'].includes(newStatus)) playAudioIfNeeded(order.firebaseKey,'entrega');
      if(data.delivery==='retirada' && newStatus==='finalizado') playAudioIfNeeded(order.firebaseKey,'retirada');
      localStorage.setItem('orderStatus_'+order.firebaseKey,newStatus);
    }

    if(newStatus==='finalizado'){
      localStorage.removeItem('orderComplete');
      localStorage.removeItem('orderStartTime');
      localStorage.removeItem('orderStatus_'+order.firebaseKey);
      localStorage.removeItem('cart');
      ORDER_COMPLETE=null;
      ORDER_START_TIME=null;
      const timelineEl=$safe('orderTimeline');
      if(timelineEl) timelineEl.classList.add('hidden');
      orderCompleteEl.classList.add('hidden');
    }
  });
}

/* ----------------- INICIALIZA√á√ÉO ----------------- */
renderCart();
renderLastOrders();
if(ORDER_COMPLETE){ showOrderComplete(); monitorStatus(ORDER_COMPLETE); }

window.addEventListener('load', ()=>{
  setTimeout(()=>{
    const s=document.getElementById('splash');
    if(s) s.style.display='none';
  },3000);
});
</script>



<script>
  let deferredPrompt;
  const installPrompt = document.getElementById('installPrompt');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); // Impede que o navegador exiba o banner autom√°tico
    deferredPrompt = e;

    // Mostrar o bot√£o de instala√ß√£o customizado
    installPrompt.style.display = 'block';
  });

  installPrompt.addEventListener('click', async () => {
    installPrompt.style.display = 'none';
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('Usu√°rio aceitou instalar');
      } else {
        console.log('Usu√°rio recusou instalar');
      }
      deferredPrompt = null;
    }
  });

  // Esconde o bot√£o se o app j√° estiver instalado
  window.addEventListener('appinstalled', () => {
    console.log('App instalado');
    installPrompt.style.display = 'none';
  });
  
</script>
</body>
</html>
